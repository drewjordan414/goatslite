# ---------- Build stage ----------
FROM node:20.12.2-alpine AS build
WORKDIR /app

# Tell Vite where the API lives (nginx will proxy /api -> api:3001)
ARG VITE_API_BASE=/api
ENV VITE_API_BASE=${VITE_API_BASE}
# Optionally materialize this for Vite's env loader
RUN echo "VITE_API_BASE=${VITE_API_BASE}" > .env.production

# Copy package.json and (optionally) package-lock.json in one go
COPY package*.json ./

# If a lockfile exists, npm ci will use it; if not, fall back to npm install
RUN npm ci || npm install

# Copy the rest of the app and build
COPY . .
RUN npm run build

# ---------- Runtime stage ----------
FROM nginx:1.27-alpine

# Your nginx.conf should proxy /api to http://api:3001 and serve static from /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Static site
COPY --from=build /app/dist/ /usr/share/nginx/html/

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
